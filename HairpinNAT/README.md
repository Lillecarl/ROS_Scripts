This script is really easy to use, just run it and it'll make hairpin nats that only hairpin when needed automagically.

Since this uses mangle you'll likely have to disable Fasttrack, i usually keep the rule but set src and dst ip to 0.0.0.0 just to keep the standard ruleset intact on SMB gateways.
